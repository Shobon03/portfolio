---
import { getCollection } from 'astro:content';
import { ArrowLeft } from '@lucide/astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { link } from '../../utils/url-helper';

// Essa função gera as rotas estáticas para cada post no build time
export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: post,
  }));
}

const post = Astro.props;
const { Content } = await post.render();

const siteUrl = Astro.site || new URL(Astro.url.origin);
const canonicalUrl = new URL(Astro.url.pathname, siteUrl);

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description: post.data.description,
  datePublished: post.data.pubDate.toISOString(),
  dateModified: post.data.updatedDate
    ? post.data.updatedDate.toISOString()
    : post.data.pubDate.toISOString(),
  image: post.data.heroImage
    ? new URL(post.data.heroImage, siteUrl).href
    : new URL('/og-image.png', siteUrl).href,
  url: canonicalUrl.href,
  author: {
    '@type': 'Person',
    name: 'Matheus',
  },
  publisher: {
    '@type': 'Organization',
    name: 'Matheus.Dev',
    logo: {
      '@type': 'ImageObject',
      url: new URL('/favicon.svg', siteUrl).href,
    },
  },
};
---

<BaseLayout title={post.data.title} description={post.data.description} jsonLd={jsonLd}>
  <article class="max-w-3xl mx-auto py-12 px-4">
    <a
      href={link('blog')}
      class="inline-flex items-center gap-2 font-bold text-brutal-black hover:text-brutal-purple transition-colors mb-8 group"
    >
      <ArrowLeft class="w-5 h-5 group-hover:-translate-x-1 transition-transform" />
      Voltar para o Blog
    </a>

    <header class="mb-12 border-b-3 border-brutal-black pb-8">
      <div class="flex flex-wrap gap-2 mb-4">
        {post.data.tags.map((tag) => (
          <span class="bg-brutal-purple text-white font-bold px-2 py-1 text-sm uppercase shadow-hard-sm border-2 border-brutal-black">
            {tag}
          </span>
        ))}
      </div>
      <h1 class="font-display text-5xl md:text-6xl font-black leading-tight mb-4 text-brutal-black" transition:name={"post-title-" + post.slug}>
        {post.data.title}
      </h1>
      <div class="font-mono font-bold text-gray-600 dark:text-gray-400">
        Publicado em {post.data.pubDate.toLocaleDateString('pt-BR', { dateStyle: 'long' })}
      </div>
    </header>

    <div class="prose prose-xl dark:prose-invert max-w-none
      prose-headings:font-display prose-headings:font-black
      prose-a:text-brutal-blue prose-a:no-underline prose-a:font-bold hover:prose-a:bg-brutal-yellow hover:prose-a:text-black
      prose-blockquote:border-l-brutal-purple
      prose-img:border-3 prose-img:border-brutal-black prose-img:shadow-hard">
      <Content />
    </div>
  </article>
</BaseLayout>
