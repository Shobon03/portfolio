---
import { Moon, Sun, Menu, X } from '@lucide/astro';
import { joinPath } from '../../utils/url-helper';

const navItems = [
  { name: 'Início', path: joinPath('') },
  { name: 'Blog', path: joinPath('blog') },
];
---

<header class="sticky top-0 z-50">
  <nav class="relative w-full bg-brutal-bg border-b-3 border-brutal-black py-4 px-4 transition-colors duration-300" transition:persist>
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <a href={joinPath("/")} class="font-display font-black text-2xl uppercase tracking-tighter hover:text-brutal-purple transition-colors z-50">
        Matheus<span class="text-brutal-blue">.Dev</span>
      </a>

      <div class="flex items-center gap-2 md:gap-6">
        <!-- Desktop Menu -->
        <ul class="hidden md:flex gap-6 font-bold text-sm uppercase tracking-widest">
          {navItems.map((item) => (
            <li>
              <a href={item.path} class="hover:underline decoration-4 underline-offset-4 decoration-brutal-yellow">
                {item.name}
              </a>
            </li>
          ))}
        </ul>

        <!-- Theme Toggle -->
        <button
          id="theme-toggle"
          class="text-brutal-black border-2 border-brutal-black hover:shadow-hard p-2 transition-all active:translate-y-[2px] active:shadow-none cursor-pointer"
          aria-label="Alternar Modo Escuro"
        >
          <Sun id="sun-icon" class="w-5 h-5 hidden" />
          <Moon id="moon-icon" class="w-5 h-5 block" />
        </button>

        <!-- Mobile Menu Button -->
        <button
          id="menu-toggle"
          class="md:hidden text-brutal-black border-2 border-brutal-black hover:shadow-hard p-2 z-50 transition-all active:translate-y-[2px] active:shadow-none"
          aria-label="Abrir Menu"
          aria-expanded="false"
        >
          <Menu id="menu-icon" class="w-5 h-5" />
          <X id="close-icon" class="w-5 h-5 hidden" />
        </button>
      </div>
    </div>
  </nav>

  <!-- Mobile Sidebar Menu -->
  <div
    id="sidebar-menu"
    class="fixed md:hidden inset-0 bg-brutal-bg z-40 transform -translate-x-full transition-transform duration-300 ease-in-out"
  >
    <div class="flex flex-col justify-center h-full pt-16 px-8">
      <ul class="flex flex-col gap-8">
        {navItems.map((item) => (
          <li>
            <a href={item.path} class="sidebar-link font-display text-4xl font-bold uppercase tracking-tighter hover:text-brutal-purple transition-colors">
              {item.name}
            </a>
          </li>
        ))}
      </ul>
    </div>
  </div>
</header>

<script is:inline>
  // --- Theme Toggler Logic ---
  const applyTheme = (theme) => {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
      document.getElementById('sun-icon')?.classList.remove('hidden');
      document.getElementById('moon-icon')?.classList.add('hidden');
    } else {
      document.documentElement.classList.remove('dark');
      document.getElementById('sun-icon')?.classList.add('hidden');
      document.getElementById('moon-icon')?.classList.remove('hidden');
    }
    localStorage.setItem('theme', theme);
  };

  const handleThemeToggle = () => {
    const isDark = document.documentElement.classList.contains('dark');
    applyTheme(isDark ? 'light' : 'dark');
  };

  const setupTheme = () => {
    const savedTheme = localStorage.getItem('theme');
    // Dark mode como padrão se não houver nada salvo
    const theme = savedTheme || 'dark';

    applyTheme(theme);

    const btn = document.getElementById('theme-toggle');
    if (btn) {
      btn.removeEventListener('click', handleThemeToggle);
      btn.addEventListener('click', handleThemeToggle);
    }
  };

  // --- Mobile Sidebar Logic ---
  const setupSidebar = () => {
    const menuToggle = document.getElementById('menu-toggle');
    const sidebarMenu = document.getElementById('sidebar-menu');
    const menuIcon = document.getElementById('menu-icon');
    const closeIcon = document.getElementById('close-icon');
    const sidebarLinks = document.querySelectorAll('.sidebar-link');

    if (!menuToggle || !sidebarMenu || !menuIcon || !closeIcon) return;

    const toggleMenu = () => {
      const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
      menuToggle.setAttribute('aria-expanded', String(!isExpanded));
      sidebarMenu.classList.toggle('-translate-x-full');
      menuIcon.classList.toggle('hidden');
      closeIcon.classList.toggle('hidden');
      document.body.classList.toggle('overflow-hidden', !isExpanded);
    };

    menuToggle.addEventListener('click', toggleMenu);

    sidebarLinks.forEach(link => {
      link.addEventListener('click', () => {
        if (menuToggle.getAttribute('aria-expanded') === 'true') {
          toggleMenu();
        }
      });
    });
  };

  // --- Initialization & Transition Handling ---
  const initializeNav = () => {
    setupTheme();
    setupSidebar();
  };

  // Initialize scripts on first page load
  initializeNav();

  // Re-initialize scripts after page transition
  document.addEventListener('astro:after-swap', () => setTimeout(initializeNav, 0));
</script>
